# -----------------------------
# NAMESPACE
# -----------------------------
apiVersion: v1
kind: Namespace
metadata:
  name: production
---
# -----------------------------
# SERVICE ACCOUNTS
# -----------------------------
apiVersion: v1
kind: ServiceAccount
metadata:
  name: mysql-sa
  namespace: production
  annotations:
    azure.workload.identity/client-id: eacfa37c-6247-44ff-891f-582614ca5cbf
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: wordpress-sa
  namespace: production
  annotations:
    azure.workload.identity/client-id: 30687c66-ca17-4187-9cbf-04ee407726c8
---
# -----------------------------
# SECRET PROVIDER CLASSES
# -----------------------------
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: mysql-kv-secrets
  namespace: production
spec:
  provider: azure
  parameters:
    usePodIdentity: "false"
    useVMManagedIdentity: "true"
    clientID: eacfa37c-6247-44ff-891f-582614ca5cbf
    keyvaultName: prodsecrets-001
    cloudName: "AzurePublicCloud"
    tenantId: 82d83ea0-1c02-4101-8dc1-e24f1a64ad6e
  secretObjects:
    - secretName: mysql-prod-secret
      type: Opaque
      data:
        - objectName: mysqluser
          key: mysqluser
        - objectName: mysql-password
          key: mysql-password
        - objectName: mysqldatabase
          key: mysqldatabase
        - objectName: mysqlrootpassword
          key: mysqlrootpassword
---
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: wordpress-kv-secrets
  namespace: production
spec:
  provider: azure
  parameters:
    usePodIdentity: "false"
    useVMManagedIdentity: "true"
    clientID: 30687c66-ca17-4187-9cbf-04ee407726c8
    keyvaultName: prodsecrets-001
    cloudName: "AzurePublicCloud"
    tenantId: 82d83ea0-1c02-4101-8dc1-e24f1a64ad6e
  secretObjects:
    - secretName: wp-prod-secret
      type: Opaque
      data:
        - objectName: mysqluser
          key: mysqluser
        - objectName: mysql-password
          key: mysql-password
        - objectName: mysqldatabase
          key: mysqldatabase
        - objectName: mysqlrootpassword
          key: mysqlrootpassword
---
# -----------------------------
# PVCs
# -----------------------------
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pvc
  namespace: production
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: wordpress-pvc
  namespace: production
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
---
# -----------------------------
# DEPLOYMENTS
# -----------------------------
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql-deployment
  namespace: production
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mysql
  template:
    metadata:
      labels:
        app: mysql
        azure.workload.identity/use: "true"
    spec:
      serviceAccountName: mysql-sa
      containers:
      - name: mysql
        image: mysql:8.0
        ports:
        - containerPort: 3306
        env:
        - name: MYSQL_USER
          valueFrom:
            secretKeyRef:
              name: mysql-prod-secret
              key: mysqluser
        - name: MYSQL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-prod-secret
              key: mysql-password
        - name: MYSQL_DATABASE
          valueFrom:
            secretKeyRef:
              name: mysql-prod-secret
              key: mysqldatabase
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-prod-secret
              key: mysqlrootpassword
        volumeMounts:
        - name: mysql-pv
          mountPath: /var/lib/mysql
        - name: secrets-store-inline
          mountPath: /mnt/secrets
          readOnly: true
      volumes:
      - name: mysql-pv
        persistentVolumeClaim:
          claimName: mysql-pvc
      - name: secrets-store-inline
        csi:
          driver: secrets-store.csi.k8s.io
          readOnly: true
          volumeAttributes:
            secretProviderClass: mysql-kv-secrets
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: wordpress-deployment
  namespace: production
spec:
  replicas: 1
  selector:
    matchLabels:
      app: wordpress
  template:
    metadata:
      labels:
        app: wordpress
        azure.workload.identity/use: "true"
    spec:
      serviceAccountName: wordpress-sa
      containers:
      - name: wordpress
        image: wordpress:5.6
        ports:
        - containerPort: 80
        env:
        - name: WORDPRESS_DB_HOST
          value: mysql-svc
        - name: WORDPRESS_DB_USER
          valueFrom:
            secretKeyRef:
              name: wp-prod-secret
              key: db-user
        - name: WORDPRESS_DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: wp-prod-secret
              key: db-password
        volumeMounts:
        - name: wordpress-pv
          mountPath: /var/www/html
        - name: secrets-store-inline
          mountPath: /mnt/secrets
          readOnly: true
      volumes:
      - name: wordpress-pv
        persistentVolumeClaim:
          claimName: wordpress-pvc
      - name: secrets-store-inline
        csi:
          driver: secrets-store.csi.k8s.io
          readOnly: true
          volumeAttributes:
            secretProviderClass: wordpress-kv-secrets
      affinity:
        podAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - mysql
            topologyKey: kubernetes.io/hostname
---
# -----------------------------
# SERVICES
# -----------------------------
apiVersion: v1
kind: Service
metadata:
  name: mysql-svc
  namespace: production
spec:
  selector:
    app: mysql
  ports:
  - port: 3306
    targetPort: 3306
---
apiVersion: v1
kind: Service
metadata:
  name: wordpress-svc
  namespace: production
spec:
  selector:
    app: wordpress
  ports:
  - port: 80
    targetPort: 80
